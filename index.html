<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Bluetooth Printer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 
        CORRECTED SCRIPT TAG: We are now loading the correct library from a reliable source (JSDelivr).
        The 'EscPosEncoder' object is provided by this script.
    -->
    <script src="https://cdn.jsdelivr.net/npm/esc-pos-encoder-js@1.c.2/dist/esc-pos-encoder.js"></script>

    <style>
        /* Your CSS is perfect, no changes needed */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 15px; background-color: #f0f2f5; }
        .header { text-align: center; margin-bottom: 20px; padding: 15px; background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .connect-btn { display: block; width: 100%; padding: 15px; font-size: 1.2rem; font-weight: 600; cursor: pointer; border: none; border-radius: 8px; color: white; background-color: #4361ee; margin-bottom: 10px; }
        .status { padding: 10px; border-radius: 5px; text-align: center; font-weight: 500; }
        .status.disconnected { background-color: #ffebee; color: #c62828; }
        .status.connecting { background-color: #fff9c4; color: #f57f17; }
        .status.connected { background-color: #e8f5e9; color: #2e7d32; }
        .product-list { margin-top: 20px; }
        .product-item { display: flex; align-items: center; padding: 15px; background-color: white; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .product-info { flex-grow: 1; }
        .product-name { font-weight: 600; }
        .product-details { font-size: 0.9rem; color: #555; }
        .print-btn { padding: 10px 15px; font-size: 1rem; cursor: pointer; border: none; border-radius: 8px; color: white; background-color: #2e9c33; white-space: nowrap; }
        .print-btn:disabled { background-color: #9e9e9e; }
    </style>
</head>
<body>

    <div class="header">
        <button id="connectBtn" class="connect-btn">
            <i class="fas fa-bluetooth-b"></i> Connect to Printer
        </button>
        <div id="status" class="status disconnected">
            Status: Disconnected
        </div>
    </div>

    <div class="product-list">
        <div class="product-item">
            <div class="product-info">
                <div class="product-name">Hustl Classic Tee</div>
                <div class="product-details">SKU: HUS-TEE-BLK-M | Size: M | MRP: â‚¹799.00</div>
            </div>
            <button class="print-btn" onclick="printLabel('Hustl Classic Tee', 'HUS-TEE-BLK-M', '799.00', 'M')" disabled>
                <i class="fas fa-print"></i> Print
            </button>
        </div>
    </div>

<script>
    // Global variables
    let printerDevice;
    let printerCharacteristic;

    // DOM Elements
    const connectBtn = document.getElementById('connectBtn');
    const statusDiv = document.getElementById('status');
    const printButtons = document.querySelectorAll('.print-btn');

    // Attach event listeners
    connectBtn.addEventListener('click', () => {
        if (printerDevice && printerDevice.gatt.connected) {
            printerDevice.gatt.disconnect();
        } else {
            connectToPrinter();
        }
    });

    function updateStatus(message, statusClass) {
        statusDiv.textContent = `Status: ${message}`;
        statusDiv.className = `status ${statusClass}`;
        const isConnected = statusClass === 'connected';
        printButtons.forEach(btn => btn.disabled = !isConnected);
        if (isConnected) {
            connectBtn.textContent = 'Disconnect Printer';
            connectBtn.style.backgroundColor = '#e63946';
        } else {
            connectBtn.textContent = 'Connect to Printer';
            connectBtn.style.backgroundColor = '#4361ee';
        }
    }

    // NEW AND IMPROVED Connection Function
    async function connectToPrinter() {
        try {
            updateStatus('Searching for printers...', 'connecting');
            
            // Step 1: Request ANY bluetooth device. This is the part that we know works.
            printerDevice = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true
            });
            
            updateStatus(`Found ${printerDevice.name}. Connecting...`, 'connecting');
            printerDevice.addEventListener('gattserverdisconnected', () => updateStatus('Disconnected', 'disconnected'));
            
            // Step 2: Connect to the GATT Server. This is where it failed before.
            const server = await printerDevice.gatt.connect();
            
            // Step 3: Discover ALL services on the device.
            const services = await server.getPrimaryServices();
            updateStatus('Discovering services...', 'connecting');

            // Step 4: Loop through all services and characteristics to find one we can write to.
            // This is the key to connecting to non-standard printers.
            for (const service of services) {
                const characteristics = await service.getCharacteristics();
                for (const characteristic of characteristics) {
                    // We are looking for a characteristic that supports "write" or "write without response".
                    if (characteristic.properties.write || characteristic.properties.writeWithoutResponse) {
                        console.log(`Found a writable characteristic: ${characteristic.uuid}`);
                        printerCharacteristic = characteristic; // Found it!
                        break; // Exit the inner loop
                    }
                }
                if (printerCharacteristic) {
                    break; // Exit the outer loop if we found one
                }
            }

            if (!printerCharacteristic) {
                // If we looped through everything and found nothing, we cannot print.
                throw new Error("No writable characteristic found on this device.");
            }

            updateStatus(`Connected to ${printerDevice.name}`, 'connected');

        } catch (error) {
            console.error('Connection failed!', error);
            updateStatus(`Connection Failed: ${error.message}`, 'disconnected');
        }
    }

    // This function now works because the EscPosEncoder library is correctly loaded.
    function printLabel(productName, sku, price, size) {
        if (!printerCharacteristic) {
            alert('Printer is not connected. Please connect first.');
            return;
        }
        
        try {
            // Initialize the encoder library
            let encoder = new EscPosEncoder();

            // Build the command sequence
            let command = encoder
                .initialize()
                .align('center')
                .bold(true)
                .line(productName)
                .bold(false)
                .newline()
                .barcode(sku, 'code128', 50)
                .newline()
                .align('left')
                .line(`MRP: Rs ${price}`)
                .line(`SIZE: ${size}`)
                .newline()
                .newline()
                .cut()
                .encode();

            // Send the commands to the printer
            printerCharacteristic.writeValue(command)
                .then(() => {
                    console.log('Print command sent successfully.');
                })
                .catch(error => {
                    console.error('Printing failed!', error);
                    alert(`Printing failed: ${error.message}`);
                });

        } catch (error) {
            console.error('Error creating print commands:', error);
            alert(`Error creating print commands: ${error.message}`);
        }
    }
</script>

</body>
</html>
